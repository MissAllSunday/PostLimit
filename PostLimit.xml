<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Suki:PostLimit</id>
	<version>1.0</version>

	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[// You must be posting to *some* board.
	if (empty($board) && !$context['make_event'])
		fatal_lang_error('no_board', false);]]></search>
			<add><![CDATA[// You must be posting to *some* board.
	if (empty($board) && !$context['make_event'])
		fatal_lang_error('no_board', false);

	/* PostLimit mod */
	$pl_postLimit = new PostLimit($user_info['id'], $board);

	/* Is this board limited? */
	if ($postLimit->isBoardLimited())
	{
		/* Get the user's post limit */
		$pl_userLimit = $pl_postLimit->getLimit();

		/* Get the user's current post count */
		$pl_userCount = $pl_postLimit->getCount();

		/* Define what we are gonna do */
		if ($pl_userCount != 0)
		{
			/* Just how many messages are left? */
			$pl_messagesLeft = $pl_userLimit - $pl_userCount;

			switch ($pl_messagesLeft)
			{
				case 1:
					$context['pl_message'] = PostLimit::tools()->getText('message_1');
				break;
				case 2:
					$context['pl_message'] = PostLimit::tools()->getText('message_2');
				break;
				case 3:
					$context['pl_message'] = PostLimit::tools()->getText('message_3');
				break;
			}
		}

		/* The user doesn't have any messages left */
		else
			fatal_error($pl_userLimit->customMessage($user_info['name']), false);
	}

	/* PostLimit mod */]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[// Sneaking off, are we?]]></search>
			<add><![CDATA[/* PostLimit mod */
	$pl_postLimit = new PostLimit($user_info['id'], $board);

	/* Get the user's post limit */
	$pl_userLimit = $pl_postLimit->getLimit();

	/* Get the user's current post count */
	$pl_userCount = $pl_postLimit->getCount();

	/* Is this board limited? */
	if ($pl_postLimit->isBoardLimited())
		if ($pl_userCount >= $pl_userLimit)
			fatal_error($pl_postLimit->customMessage($user_info['name']), false);
	/* PostLimit mod */

	// Sneaking off, are we?]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[if (isset($topicOptions['id']))
			$topic = $topicOptions['id'];]]></search>
			<add><![CDATA[if (isset($topicOptions['id']))
			$topic = $topicOptions['id'];

		/* Post Limit mod */
		$pl_postLimit =  new PostLimit($user_info['id']);
		$pl_postLimit->updateCount();]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[// Find the previous or next topic.  Make a fuss if there are no more.]]></search>
			<add><![CDATA[/* Let's define some $context vars for the PostLimit mod shall we? */
	$pl_postLimit = new PostLimit($user_info['id'], $board_info['id']);
	$context['postLimit'] = array(
		'message' => '',
		'title' => ''
	);

	/* Is this board limited? */
	if ($pl_postLimit->isBoardLimited())
	{
		/* Get the user's post limit */
		$pl_userLimit = $pl_postLimit->getLimit();

		/* Get the user's current post count */
		$pl_userCount = $pl_postLimit->getCount();

		$context['postLimit']['title'] = sprintf(PostLimit::tools()->getText('message_title'), $user_info['name']);

		/* Define what we are gonna do */
		if ($pl_userCount < $pl_userLimit)
		{
			/* Just how many messages are left? */
			$pl_messagesLeft = $pl_userLimit - $pl_userCount;

			if ($pl_messagesLeft <= 3)
				$context['postLimit']['message'] = sprintf(PostLimit::tools()->getText('message'), $pl_messagesLeft);
		}

		elseif ($pl_userCount >= $pl_userLimit)
			$context['postLimit']['message'] = sprintf(PostLimit::tools()->getText('message_overlimit'), $pl_userLimit);
	}
	/* PostLimit mod */

	// Find the previous or next topic.  Make a fuss if there are no more.]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ScheduledTasks.php">
		<operation>
			<search position="replace"><![CDATA[// Perform the standard checks on expiring/near expiring subscriptions.]]></search>
			<add><![CDATA[/* Post Limit mod */
function scheduled_postLimit()
{
	global $smcFunc;

	$result = $smcFunc['db_query']('',
		'UPDATE {db_prefix}post_limit
		SET post_count = 0',
		array()
	);

	return true;
}

// Perform the standard checks on expiring/near expiring subscriptions.]]></add>
		</operation>
	</file>

	<file name="$themedir/Post.template.php">
		<operation>
			<search position="replace"><![CDATA[// If the user wants to see how their message looks - the preview section is where it's at!]]></search>
			<add><![CDATA[/* Post Limit mod */
	if (!empty($context['postLimit']['message']))
		echo '
			<div id="postLimit">
				<div class="cat_bar">
					<h3 class="catbg">
						<span id="preview_subject">', $context['postLimit']['title'] ,'</span>
					</h3>
				</div>
				<div class="windowbg">
					<span class="topslice"><span></span></span>
					<div class="content">
						<div class="post" id="preview_body">
							', $context['postLimit']['message'] , '
						</div>
					</div>
					<span class="botslice"><span></span></span>
				</div>
			</div><br />';

	// If the user wants to see how their message looks - the preview section is where it's at!]]></add>
		</operation>
	</file>

	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[if ($context['can_reply'] && !empty($options['display_quick_reply']))
	{]]></search>
			<add><![CDATA[if ($context['can_reply'] && !empty($options['display_quick_reply']))
	{
		/* Post Limit mod */
		if (!empty($context['postLimit']['message']))
			echo '
				<div id="postLimit">
					<div class="cat_bar">
						<h3 class="catbg">
							<span id="preview_subject">', $context['postLimit']['title'] ,'</span>
						</h3>
					</div>
					<div class="windowbg">
						<span class="topslice"><span></span></span>
						<div class="content">
							<div class="post" id="preview_body">
								', $context['postLimit']['message'] , '
							</div>
						</div>
						<span class="botslice"><span></span></span>
					</div>
				</div><br />';]]></add>
		</operation>
	</file>
</modification>